"use strict";var map=(function(m,D){var z=m.tileLayer("http://openmapsurfer.uni-hd.de/tiles/roads/x={x}&y={y}&z={z}",{maxZoom:16,attribution:'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),B,J,M=undefined,k=undefined,h=Number.NaN,b=Number.NaN,O=false;var E=m.Icon.extend({options:{shadowUrl:"/static/images/leaflet/marker-shadow.png",shadowAnchor:[13,41],iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}}),l=new E({iconUrl:"/static/images/leaflet/marker-green.png"}),A=new E({iconUrl:"/static/images/leaflet/marker-purple.png"}),j=new E({iconUrl:"/static/images/leaflet/marker-red.png"}),H=new E({iconUrl:"/static/images/leaflet/marker-yellow.png"}),N=new E({iconUrl:"/static/images/leaflet/marker-blue.png"}),w=new E({iconUrl:"/static/images/leaflet/marker-user.png"});var I=[{id:1,lat:50.05346,lng:19.8535,priority:1,name:"Name of the task, bla bla",dateDue:"30.07.2015"},{id:2,lat:50.03597,lng:20.04627,priority:2,name:"Name of the task, bla bla",dateDue:"30.07.2015"},{id:3,lat:50.04762,lng:19.94637,priority:3,name:"Name of the task, bla bla",dateDue:"30.07.2015"},{id:4,lat:50.04773,lng:19.90963,priority:1,name:"Name of the task",dateDue:"30.07.2015"},{id:5,lat:50.05346,lng:19.8535,priority:2,name:"Name of the task, bla bla",dateDue:"30.07.2015"},{id:6,lat:50.07285,lng:19.94688,priority:3,name:"Name of the task",dateDue:"30.07.2015"}];function u(S){h=S.latlng.lat;b=S.latlng.lng;console.log([h,b]);m.marker(S.latlng,{icon:w}).addTo(B).bindPopup("<b>You are here</b><br/> or "+S.accuracy/2+"m away").openPopup()}function f(S){console.log("[error] getting coordinates :< USER, WHY U NO ACCEPT. "+S.message);alert("USER, WHY U NO ACCEPT :<")}function y(S){I=S}function Q(){B=m.map("map");B.on("locationfound",u);B.on("locationerror",f);z.addTo(B);B.locate({setView:true,maxZoom:14})}function P(W){var V=Number.NEGATIVE_INFINITY,T=Number.NEGATIVE_INFINITY,X=Number.POSITIVE_INFINITY,U=Number.POSITIVE_INFINITY;for(var S=0;S<I.length;S++){if(I[S].lat>V){V=I[S].lat}if(I[S].lng>T){T=I[S].lng}if(I[S].lat<X){X=I[S].lat}if(I[S].lng<U){U=I[S].lng}}if(W){return[(V+X)/2,(T+U/2)]}else{B.fitBounds(new m.latLngBounds(new m.latLng(X,U),new m.latLng(V,T)))}}function g(T,V,U,S){return m.marker([U,S],{draggable:true}).bindPopup("Here").on("dragend",function(W){var X=W.target.getLatLng();D(T).val(Utils.roundCoord(X.lat));D(V).val(Utils.roundCoord(X.lng));this.openPopup()}).addTo(B)}function C(T,V,U,S){if(!M&&U&&S){M=g(T,V,U,S).openPopup()}B.on("click",function(W){if(!M){M=g(T,V,W.latlng.lat,W.latlng.lng).openPopup();D(T).val(Utils.roundCoord(W.latlng.lat));D(V).val(Utils.roundCoord(W.latlng.lng))}else{M.setLatLng(W.latlng).openPopup()}})}function i(S){var T;for(var V in B._layers){if(B._layers[V].task_id==S){B._layers[V].openPopup();break}}for(var U=0;U<I.length;U++){if(I[U].id==S){T=I[U];break}}try{B.panTo([T.lat,T.lng])}catch(W){console.log("[MAP] panToTask ERROR :<")}}function K(){return h&&b}function G(){if(K()){B.panTo([h,b])}}function d(V,U,S,T){return"<b>Due: "+S+'</b><br/><hr class="thin"><span>'+Utils.cutToLength(U,16)+'</span><br/><a class="place-left" href="/tasks/'+V+'/">&raquo; more</a> '}function R(){return"<b>Your destination</b>"}function r(T,S){B.panTo([T,S])}function n(T,S){if(!k){k=m.marker([T,S]).bindPopup(R()).addTo(B).openPopup()}}function q(T,V){if(B){var X=[];if(J){try{B.removeLayer(J)}catch(W){console.log("[MAP] repopulate ERROR :<")}}if(V){for(var U=0;U<I.length;U++){var S;switch(I[U].priority){case 1:S=m.marker([I[U].lat,I[U].lng],{icon:l}).bindPopup(d(I[U].id,I[U].name,I[U].dateDue));S.task_id=I[U].id;X.push(S);break;case 2:S=m.marker([I[U].lat,I[U].lng],{icon:H}).bindPopup(d(I[U].id,I[U].name,I[U].dateDue));S.task_id=I[U].id;X.push(S);break;case 3:S=m.marker([I[U].lat,I[U].lng],{icon:j}).bindPopup(d(I[U].id,I[U].name,I[U].dateDue));S.task_id=I[U].id;X.push(S);break;default:S=m.marker([I[U].lat,I[U].lng]).bindPopup(d(I[U].id,I[U].name,I[U].dateDue));S.task_id=I[U].id;X.push(S);break}}}else{if(T){for(var U=0;U<I.length;U++){if(I[U].priority==2){var S=m.marker([I[U].lat,I[U].lng],{icon:j}).bindPopup(d(I[U].id,I[U].name,I[U].dateDue));S.task_id=I[U].id;X.push(S)}}}else{for(var U=0;U<I.length;U++){var S=m.marker([I[U].lat,I[U].lng]).bindPopup(d(I[U].id,I[U].name,I[U].dateDue));S.task_id=I[U].id;X.push(S)}}}J=m.layerGroup(X).addTo(B);P()}}function s(S){y(S)}function t(){q(true,false)}function o(){if(O){q(false,false);O=false}else{q(false,true);O=true}}function x(){q(false,false)}function c(){P(false)}function v(T,S){r(T,S)}function e(T,S){n(T,S)}function p(){if(k){r(k._latlng.lat,k._latlng.lng)}}function a(U,S,V,T){C(U,S,V,T)}function F(){__setMovableMarker()}return{init:Q,setData:s,repopulate:x,repopulatePriority:o,repopulateUrgent:t,center:c,panToCoords:v,panToTask:i,addSingleTask:e,singleTaskLocation:p,registerCreationEvents:a,userLocation:G,userCheckLocation:K,DEBUG:function(){return B}}})(L,jQuery);